#!/bin/env sh

SSH_DIR="$HOME/.ssh"
DOTFILES_DIR="$HOME/Documents/github/ansible-dots/bin/dotfiles"

update_ansible_galaxy() {
  OS=$1
  OS_REQUIREMENTS=""
  if [ -f "$DOTFILES_DIR/requirements/$OS.yml" ]; then
    OS_REQUIREMENTS="$DOTFILES_DIR/requirements/$OS.yml"
  fi
  # ansible-galaxy install -r "$DOTFILES_DIR"/requirements/common.yml "$OS_REQUIREMENTS"
  ansible-galaxy install -r "$OS_REQUIREMENTS"
}

detect_os() {
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    echo "$ID"
  else
    uname -s | tr '[:upper:]' '[:lower:]'
  fi
}

ubuntu_setup() {
  if ! dpkg -s ansible >/dev/null 2>&1; then
    sudo apt-get update
    sudo apt-get install -y software-properties-common
    sudo apt-add-repository -y ppa:ansible/ansible
    sudo apt-get update
    sudo apt-get install -y ansible
    sudo apt-get install -y python3-argcomplete
    sudo activate-global-python-argcomplete3
  fi
  if ! dpkg -s python3 >/dev/null 2>&1; then
    sudo apt-get install -y python3
  fi
  UBUNTU_MAJOR_VERSION=$(echo "$VERSION_ID" | cut -d. -f1)
  if [ "$UBUNTU_MAJOR_VERSION" -le 22 ]; then
    if ! dpkg -s python3-pip >/dev/null 2>&1; then
      sudo apt-get install -y python3-pip
    fi
    if ! pip3 list | grep watchdog >/dev/null 2>&1; then
      sudo apt-get install -y python3-watchdog
    fi
  fi
}

arch_setup() {
  if ! command -v ansible >/dev/null 2>&1; then
    echo "Installing Ansible"
    sudo pacman -Sy --noconfirm
    sudo pacman -S --noconfirm ansible
    sudo pacman -S --noconfirm python-argcomplete
  fi
  if ! pacman -Q python3 >/dev/null 2>&1; then
    echo "Installing Python3"
    sudo pacman -S --noconfirm python3
  fi
  if ! pacman -Q python-pip >/dev/null 2>&1; then
    echo "Installing Python3 Pip"
    sudo pacman -S --noconfirm python-pip
  fi
  if ! pip3 list | grep watchdog >/dev/null 2>&1; then
    echo "Installing Python3 Watchdog"
    sudo pacman -S --noconfirm python-watchdog
  fi
  if ! pacman -Q openssh >/dev/null 2>&1; then
    echo "Installing OpenSSH"
    sudo pacman -S --noconfirm openssh
  fi
  echo "Setting Locale"
  sudo localectl set-locale LANG=en_US.UTF-8
}

DOTFILES_OS=$(detect_os)
echo "Loading Setup for detected OS: $DOTFILES_OS"

case $DOTFILES_OS in
arch)
  arch_setup
  ;;
ubuntu)
  ubuntu_setup
  ;;
*)
  echo "Unsupported OS"
  exit 1
  ;;
esac

if [ ! -f "$SSH_DIR/private/personal_github" ]; then
  mkdir -p "$SSH_DIR"
  chmod 700 "$SSH_DIR"
  echo "create ssh private key"
fi

update_ansible_galaxy "$DOTFILES_OS"
ansible-playbook "$DOTFILES_DIR/main.yml" "$@"

exit 0
